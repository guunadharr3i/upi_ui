name: Build and Upload Flutter Web WAR to pCloud by Tag
run-name: Build WAR for ${{ inputs.tag_name || 'manual-run' }}

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag to create & build (e.g., uat-v1.0.0)"
        required: true
        type: string
      base_ref:
        description: "Branch or commit to tag (defaults to main)"
        required: false
        default: main
        type: string
      overwrite_tag:
        description: "If tag exists, delete & recreate it"
        required: false
        default: false
        type: boolean

permissions:
  contents: write  # needed to push tags and create releases

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.set_env.outputs.env_name }}
      tag_name: ${{ steps.extract_env.outputs.tag_name }}
      base_ref: ${{ steps.extract_env.outputs.base_ref }}
      overwrite_tag: ${{ steps.extract_env.outputs.overwrite_tag }}

    steps:
      - name: Validate input is non-empty
        if: ${{ inputs.tag_name == '' || inputs.tag_name == null }}
        run: |
          echo "ERROR: You must provide a tag name when running manually."
          exit 1

      - name: Validate tag format (expects <env>-<rest>)
        run: |
          if ! echo "${{ inputs.tag_name }}" | grep -Eq '^[A-Za-z0-9]+-'; then
            echo "ERROR: Tag should start with an environment prefix followed by a dash (e.g., uat-v1.0.0)."
            exit 1
          fi
          if ! echo "${{ inputs.tag_name }}" | grep -Eq '^[A-Za-z0-9._-]+$'; then
            echo "ERROR: Tag may only contain letters, numbers, dot, underscore, and dash."
            exit 1
          fi

      - name: Extract inputs
        id: extract_env
        run: |
          TAG_NAME="${{ inputs.tag_name }}"
          BASE_REF="${{ inputs.base_ref }}"
          OVERWRITE="${{ inputs.overwrite_tag }}"
          ENV_PREFIX="${TAG_NAME%%-*}"

          echo "env_prefix=$ENV_PREFIX" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "base_ref=$BASE_REF" >> "$GITHUB_OUTPUT"
          echo "overwrite_tag=$OVERWRITE" >> "$GITHUB_OUTPUT"

      - name: Set GitHub Environment name (uppercased)
        id: set_env
        run: |
          PREFIX='${{ steps.extract_env.outputs.env_prefix }}'
          ENV_NAME=$(echo "$PREFIX" | tr '[:lower:]' '[:upper:]')
          echo "env_name=$ENV_NAME" >> "$GITHUB_OUTPUT"

      - name: Show selected settings
        run: |
          echo "Environment:  ${{ steps.set_env.outputs.env_name }}"
          echo "Tag to make:  ${{ steps.extract_env.outputs.tag_name }}"
          echo "Base ref:     ${{ steps.extract_env.outputs.base_ref }}"
          echo "Overwrite:    ${{ steps.extract_env.outputs.overwrite_tag }}"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ needs.build.outputs.env_name }}

    steps:
      - name: Checkout repository (base ref)
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.build.outputs.base_ref || 'main' }}
          fetch-depth: 0
          persist-credentials: true  # needed to push tag

      - name: Create or update tag on the chosen ref
        env:
          TAG: ${{ needs.build.outputs.tag_name }}
          OVERWRITE: ${{ needs.build.outputs.overwrite_tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Identify actor for tag author info
          git config user.name  "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          echo "Fetching tags..."
          git fetch --tags --force

          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            if [ "$OVERWRITE" = "true" ]; then
              echo "Tag '$TAG' exists; overwriting as requested."
              git tag -d "$TAG" || true
              git push origin ":refs/tags/$TAG" || true
            else
              echo "ERROR: Tag '$TAG' already exists. Re-run with overwrite_tag=true to replace it."
              exit 1
            fi
          fi

          # Create annotated tag at current HEAD and push it
          echo "Creating annotated tag: $TAG"
          git tag -a "$TAG" -m "Release $TAG"
          echo "Pushing tag to origin..."
          git push origin "$TAG"

          echo "Verifying remote tag exists..."
          git ls-remote --tags origin | grep -q "refs/tags/$TAG$" || { echo "Remote tag verification failed."; exit 1; }

          echo "Checking out the tag to lock build source..."
          git checkout -f "tags/$TAG"
          echo "At commit: $(git rev-parse --short HEAD)"

      - name: Set up Flutter (stable channel)
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"   # pin with flutter-version if you prefer

      - name: Flutter doctor (diagnostics)
        run: flutter doctor -v

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            **/.dart_tool/package_config.json
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Flutter Web App
        run: flutter build web   # no --web-renderer flag

      - name: Create WAR File
        run: |
          cd build/web
          zip -r ../../UPIUI.war .
          cd ../..
          ls -lh UPIUI.war

      - name: Upload WAR to GitHub Release (attach to created tag)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag_name }}
          files: UPIUI.war
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for pCloud
        env:
          RCLONE_PCLOUD_TOKEN_JSON: ${{ secrets.RCLONE_PCLOUD_TOKEN_JSON }}
        run: |
          mkdir -p ~/.config/rclone
          {
            echo "[pcloud]"
            echo "type = pcloud"
            echo "token = ${RCLONE_PCLOUD_TOKEN_JSON}"
          } > ~/.config/rclone/rclone.conf

          echo "Configured remotes:"
          rclone listremotes || { echo "rclone config invalid"; cat ~/.config/rclone/rclone.conf; exit 1; }

      - name: Upload WAR to pCloud
        run: |
          ENV='${{ needs.build.outputs.env_name }}'
          TARGET_DIR="pcloud:/GitHubFlutterBuilds/${ENV}"

          echo "Creating target dir: $TARGET_DIR"
          rclone mkdir "$TARGET_DIR"

          echo "Uploading UPIUI.war to $TARGET_DIR"
          rclone copy "UPIUI.war" "$TARGET_DIR" --progress --checksum --transfers=4

          echo "Listing uploaded file:"
          rclone ls "$TARGET_DIR" | grep UPIUI.war || { echo "Upload not found in listing"; exit 1; }
